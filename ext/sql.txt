create database elpdb;

use elpdb;

create table status
(
    status_id int auto_increment primary key,
    name char(25) not null
);
ALTER TABLE status CHANGE COLUMN name status CHAR(25) NOT NULL;


create table countries
(
    country_id int auto_increment primary key,
    country char(50) not null,
    flag char(50) not null,
    country_code int not null
);

create table user_types
(
    user_type_id int auto_increment primary key,
    name char(25) not null
);

insert into user_types (name) values ('Trainer'),('Learner');

create table users
(
    user_id int auto_increment primary key,
    name char(50) not null,
    email char(255) not null unique,
    about_me varchar(2000),
    password char(255) not null,
    profile_pic char(255),
    phone char(10) not null unique,
    dob date,
    gender char(1),
    status_id int not null default 1,
    created_on datetime not null,
    country_id int not null,
    user_type_id int not null default 2,
    constraint fk_users_status foreign key (status_id) references status (status_id),
    constraint fk_users_countries foreign key (country_id) references countries (country_id),
    constraint fk_users_user_types foreign key (user_type_id) references user_types (user_type_id)
);
 update users set status_id=1 where user_id=14;
 ALTER TABLE users ALTER COLUMN status_id SET DEFAULT 1;
 update users set user_type_id=1 where user_type_id=2;
 ALTER TABLE users ALTER COLUMN user_type_id SET DEFAULT 2;


create table trainers
(
    trainer_id int auto_increment primary key,
    user_id int not null,
    experience varchar(500) not null,
    skills char(255) not null,
    launched_courses int not null default 0,
    profession char(255) not null,
    education char(255) not null,
    constraint fk_trainers_users foreign key (user_id) references users(user_id)
);

create table courses
(
    course_id int auto_increment primary key,
    trainer_id int not null,
    course_name char(255) not null,
    thumbnail char(255) not null,
    learning_outcomes varchar(500) not null,
    description varchar(5000) not null,
    course_topics varchar(2000) not null,
    key_features varchar(4000) not null,
    pdf char(255) not null,
    certification varchar(500) not null,
    prerequisites varchar(500) not null,
    validity_till int not null default -1,
    refund_policy char(255) not null,
    price int not null,
    discount int not null default 0,
    subscribers int not null default 0,
    total_clicks int not null default 0,
    star_rank int not null default 0,
    status_id int not null default 3,
    videos int not null default 0,
    total_hours int not null default 0,
    constraint fk_courses_trainers foreign key (trainer_id) references trainers(trainer_id),
    constraint fk_courses_status foreign key (status_id) references status(status_id)
);

SELECT c.course_id, c.course_name, c.thumbnail, c.price, c.discount,
       (c.price - (c.price * c.discount / 100)) AS discounted_price,
       c.star_rank, c.total_clicks,
       s.status
FROM courses c
JOIN status s ON c.status_id = s.status_id;



create table course_topics
(
    course_topic_id int auto_increment primary key,
    topic_name char(100) not null,
    course_id int not null,
    preview boolean not null default false,
    videos int not null default 0,
    total_hours int not null default 0,
    constraint fk_course_topics_courses foreign key (course_id) references courses (course_id)
);

create table sub_topics
(
    sub_topic_id int auto_increment primary key,
    course_topic_id int not null,
    title char(100) not null,
    preview boolean not null default false,
    videos char(255) not null,
    duration int not null default 0,
    constraint fk_sub_topics_course_topics foreign key (course_topic_id) references course_topics (course_topic_id)
);

 SELECT COUNT(*) AS subtopic_count FROM sub_topics AS st JOIN course_topics AS ct ON st.course_topic_id = ct.course_topic_id WHERE ct.course_id = 1;
 select st.sub_topic_id, st.title from sub_topics st where st.course_topic_id=?


create table carts
(
    cart_id int auto_increment primary key,
    user_id int not null,
    cart_date datetime not null,
    cart_total int not null default 0,
    courses_added int not null default 0,
    transaction_pic char(255),
    status_id int not null default 8,
    constraint fk_carts_users foreign key (user_id) references users(user_id),
    constraint fk_carts_status foreign key (status_id) references status(status_id)
);

SELECT c.thumbnail, c.course_name, ci.price, ci.discount
    FROM carts ct
    JOIN cart_items ci ON ct.cart_id = ci.cart_id
    JOIN courses c ON ci.course_id = c.course_id
    WHERE ct.user_id = ?
    

create table cart_items
(
    cart_items_id int auto_increment primary key,
    cart_id int not null,
    course_id int not null,
    price int not null,
    discount int not null default 0,
    constraint fk_cart_items_carts foreign key (cart_id) references carts(cart_id),
    constraint fk_cart_items_courses foreign key (course_id) references courses(course_id)
);
UPDATE carts c
JOIN cart_items ci ON c.cart_id = ci.cart_id
SET c.cart_total = c.cart_total - ci.price
WHERE ci.cart_items_id = ?;

DELETE FROM cart_items WHERE cart_items_id = ?;


create table subscriptions
(
    subscription_id int auto_increment primary key,
    user_id int not null,
    course_id int not null,
    purchase_date datetime not null,
    price int not null,
    validity_till int not null,
    status_id int not null default 5,
    constraint fk_subscriptions_users foreign key (user_id) references users(user_id),
    constraint fk_subscriptions_courses foreign key (course_id) references courses(course_id),
    constraint fk_subscriptions_status foreign key (status_id) references status(status_id)
);

SELECT 
    s.subscription_id, 
    s.user_id, 
    s.course_id, 
    s.purchase_date, 
    s.price, 
    s.validity_till, 
    c.course_name, 
    c.thumbnail, 
    st.status_id, 
    st.status
FROM 
    subscriptions s
JOIN 
    courses c ON s.course_id = c.course_id
JOIN 
    status st ON s.status_id = st.status_id
WHERE 
    s.user_id = 16



create table wishlist
(
    wishlist_id int auto_increment primary key,
    user_id int not null,
    course_id int not null,
    constraint fk_wishlist_users foreign key (user_id) references users(user_id),
    constraint fk_wishlist_courses foreign key (course_id) references courses(course_id)
);






